<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Matches - AI Resume Matcher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .match-selector {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .match-selector h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .resume-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .resume-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .loading-section {
            text-align: center;
            padding: 60px 20px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .matches-section {
            margin-top: 40px;
        }

        .matches-section h2 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .matches-section p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .matches-list {
            display: grid;
            gap: 25px;
        }

        .match-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s;
        }

        .match-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .match-card.excellent {
            border-left-color: #38ef7d;
        }

        .match-card.good {
            border-left-color: #667eea;
        }

        .match-card.fair {
            border-left-color: #f093fb;
        }

        .match-card.poor {
            border-left-color: #f5576c;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .match-card h3 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .match-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .match-card p {
            color: #555;
            margin: 8px 0;
        }

        .match-card strong {
            color: #333;
        }

        .skills-match {
            margin: 15px 0;
        }

        .skills-match h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .skill-tag.matched {
            background: #38ef7d;
        }

        .no-matches {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .no-matches-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .no-matches h3 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .no-matches p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .no-resume-uploaded {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .no-resume-uploaded h3 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .no-resume-uploaded p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px 5%;
            text-align: center;
            margin-top: 60px;
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .match-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div id="mainNav"></div>

    <div class="container">
        <div class="page-header">
            <h1>Find Your Job Matches</h1>
        </div>

        <!-- Admin only: Resume selector -->
        <div class="match-selector" id="matchSelector" style="display: none;">
            <h2>Select Resume (Admin)</h2>
            <select id="resumeSelect" class="resume-select">
                <option value="">-- Select Resume --</option>
            </select>
            <button id="findMatchesBtn" class="btn btn-primary">Find Matches</button>
        </div>

        <!-- User: No resume uploaded yet -->
        <div class="no-resume-uploaded" id="noResumeSection" style="display: none;">
            <div style="font-size: 5rem; margin-bottom: 20px;">ðŸ“„</div>
            <h3>No Resume Uploaded</h3>
            <p>Please upload your resume first to see job matches.</p>
            <a href="/upload.html" class="btn btn-primary">Upload Resume</a>
        </div>

        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="loader"></div>
            <p>Finding your perfect matches...</p>
        </div>

        <div id="matchesSection" class="matches-section" style="display: none;">
            <h2>Matches for <span id="candidateName"></span></h2>
            <p>Found <span id="matchCount"></span> matching jobs</p>
            <div id="matchesList" class="matches-list"></div>
        </div>

        <div id="noMatchesSection" class="no-matches" style="display: none;">
            <div class="no-matches-icon">ðŸ˜”</div>
            <h3>No Matches Found</h3>
            <p>We couldn't find any jobs matching your profile at the moment.</p>
            <p>Try uploading an updated resume or check back later for new opportunities.</p>
            <a href="/upload.html" class="btn btn-primary">Upload New Resume</a>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 AI Resume Matcher. All rights reserved.</p>
    </footer>

    <script src="../js/navbar.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/api';
        
        // Get user data
        const userData = JSON.parse(localStorage.getItem('user') || '{}');
        const userRole = userData.role || 'guest';

        // Check if resumeId is in URL (coming from upload page)
        const urlParams = new URLSearchParams(window.location.search);
        const resumeIdFromURL = urlParams.get('resumeId');

        // Initialize based on role and URL
        if (resumeIdFromURL) {
            // Coming from upload page - show matches directly
            findMatchesForResume(resumeIdFromURL);
        } else if (userRole === 'admin') {
            // Admin: Show resume selector for all resumes
            document.getElementById('matchSelector').style.display = 'block';
            loadAllResumes();
        } else if (userRole === 'user') {
            // Regular user: Find their own resume and show matches
            loadUserResume();
        } else {
            // Not logged in
            alert('Please login to view matches');
            window.location.href = '/login.html';
        }

        // Load all resumes (Admin only)
        async function loadAllResumes() {
            try {
                const response = await fetch(`${API_URL}/resumes`);
                const resumes = await response.json();

                const select = document.getElementById('resumeSelect');
                
                if (resumes.length === 0) {
                    select.innerHTML = '<option value="">No resumes uploaded yet</option>';
                    return;
                }

                resumes.forEach(resume => {
                    const option = document.createElement('option');
                    option.value = resume._id;
                    option.textContent = `${resume.candidateName} - ${resume.email || 'No email'}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading resumes:', error);
            }
        }

        // Load user's own resume (User only)
        async function loadUserResume() {
            try {
                document.getElementById('loadingSection').style.display = 'block';
                
                const response = await fetch(`${API_URL}/resumes`);
                const resumes = await response.json();

                // Find user's resume (most recent one)
                // You might want to filter by user email or add user ID to resume model
                const userResume = resumes.find(r => r.email === userData.email) || resumes[0];

                document.getElementById('loadingSection').style.display = 'none';

                if (!userResume) {
                    // No resume found
                    document.getElementById('noResumeSection').style.display = 'block';
                    return;
                }

                // Automatically find matches for user's resume
                findMatchesForResume(userResume._id);
            } catch (error) {
                console.error('Error loading user resume:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('noResumeSection').style.display = 'block';
            }
        }

        // Find matches button click (Admin only)
        if (document.getElementById('findMatchesBtn')) {
            document.getElementById('findMatchesBtn').addEventListener('click', () => {
                const resumeId = document.getElementById('resumeSelect').value;
                
                if (!resumeId) {
                    alert('Please select a resume');
                    return;
                }

                findMatchesForResume(resumeId);
            });
        }

        // Find matches for specific resume
        async function findMatchesForResume(resumeId) {
            document.getElementById('matchSelector').style.display = 'none';
            document.getElementById('noResumeSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('matchesSection').style.display = 'none';
            document.getElementById('noMatchesSection').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/matches/${resumeId}`);
                const data = await response.json();

                document.getElementById('loadingSection').style.display = 'none';

                if (!data.matches || data.matches.length === 0) {
                    document.getElementById('noMatchesSection').style.display = 'block';
                    return;
                }

                // Display matches
                document.getElementById('candidateName').textContent = data.candidateName;
                document.getElementById('matchCount').textContent = data.matches.length;
                
                const matchesList = document.getElementById('matchesList');
                matchesList.innerHTML = '';

                data.matches.forEach(match => {
                    const matchCard = createMatchCard(match);
                    matchesList.appendChild(matchCard);
                });

                document.getElementById('matchesSection').style.display = 'block';
            } catch (error) {
                console.error('Error finding matches:', error);
                document.getElementById('loadingSection').style.display = 'none';
                alert('Error finding matches. Please try again.');
            }
        }

        // Create match card HTML
        function createMatchCard(match) {
            const card = document.createElement('div');
            
            let matchClass = 'poor';
            if (match.matchScore >= 80) matchClass = 'excellent';
            else if (match.matchScore >= 60) matchClass = 'good';
            else if (match.matchScore >= 40) matchClass = 'fair';

            card.className = `match-card ${matchClass}`;
            
            const matchedSkills = match.matchedSkills || [];
            const requiredSkills = Array.isArray(match.job.requiredSkills) 
                ? match.job.requiredSkills 
                : match.job.requiredSkills.split(',').map(s => s.trim());

            card.innerHTML = `
                <div class="match-header">
                    <div>
                        <h3>${match.job.title}</h3>
                        <p><strong>Company:</strong> ${match.job.company || 'Not specified'}</p>
                    </div>
                    <div class="match-score">${Math.round(match.matchScore)}%</div>
                </div>
                
                <p><strong>Location:</strong> ${match.job.location || 'Not specified'}</p>
                <p><strong>Type:</strong> ${match.job.jobType}</p>
                <p><strong>Experience:</strong> ${match.job.experienceRequired || 'Not specified'}</p>
                
                <div class="skills-match">
                    <h4>Matched Skills (${matchedSkills.length}/${requiredSkills.length}):</h4>
                    <div class="skills-list">
                        ${requiredSkills.map(skill => {
                            const isMatched = matchedSkills.some(ms => 
                                ms.toLowerCase() === skill.toLowerCase()
                            );
                            return `<span class="skill-tag ${isMatched ? 'matched' : ''}">${skill.trim()}</span>`;
                        }).join('')}
                    </div>
                </div>
                
                <p style="margin-top: 15px;"><strong>Posted:</strong> ${new Date(match.job.postedDate).toLocaleDateString()}</p>
            `;

            return card;
        }
    </script>
</body>
</html>
